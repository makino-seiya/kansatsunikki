# 要件定義書

## 概要

子供が育てている植物（デフォルト：朝顔（あさがお）、向日葵（ひまわり）、秋桜（コスモス））の成長記録を管理するWebアプリケーション。ユーザー画面はBasic認証で保護され、スマホでアプリライクなタブナビゲーションを使って日々の成長記録を写真と共に記録でき、管理者はID/パスワードでログインして全ての記録と植物種類設定を管理できる。

## 要件

### 要件 1

**ユーザーストーリー:** 子供として、植物の成長記録を簡単に入力したいので、共通項目（日時、天気、気温）と植物ごとの個別項目（写真、高さ、コメント）を記録できるようにしたい

#### 受入基準

1. WHEN ユーザーが記録画面にアクセスした時 THEN システムは、編集不可能な当日の日時と、天気・気温の入力フィールドを表示する
2. WHEN ユーザーが天気を選択する時 THEN システムは晴れ、曇り、雨、雷の4つの選択肢を提供する
3. WHEN ユーザーが共通項目を入力した時 THEN システムは朝顔（あさがお）、向日葵（ひまわり）、秋桜（コスモス）それぞれの個別入力セクション（写真、高さ、コメント）を表示する
4. WHEN ユーザーが各植物の写真をアップロードする時 THEN システムは植物ごとに1枚の写真をプレビュー表示し、3MB以下のファイルサイズであることを検証後、ブラウザで圧縮してから適切な形式で保存する
5. WHEN ユーザーが写真を差し替えたい時 THEN システムは既存の写真を削除し、新しい写真をアップロードできる機能を提供する
6. WHEN ユーザーが編集画面で写真を変更したい時 THEN システムは現在の写真を表示し、新しい写真をアップロードまたは写真を削除する機能を提供する
7. WHEN ユーザーが各植物の高さを数値で入力した時 THEN システムは植物ごとに単位（cm：センチメートル）と共に記録する
8. WHEN ユーザーが記録を保存する時 THEN システムは、その日付の記録がまだ存在しないことを確認した上で、共通項目と各植物の個別項目を検証し、データベースに保存する
9. WHEN ユーザーが既に記録済みの日に記録を保存しようとした時 THEN システムはエラーメッセージを表示し、重複して保存できないことを伝える

### 要件 2

**ユーザーストーリー:** 子供として、過去の記録を修正したいので、既存の記録を編集・削除できるようにしたい

#### 受入基準

1. WHEN ユーザーが記録一覧を表示した時 THEN システムは全ての記録を日付順で表示し、各記録に編集ボタンを表示する
2. WHEN ユーザーが編集ボタンをクリックした時 THEN システムは既存データが入力された編集フォームをモーダルで表示する
3. WHEN 編集フォームが表示された時 THEN システムは記録されていない植物も含めて全ての植物種類（ひまわり、コスモス、朝顔（あさがお））の編集フィールドを表示する
4. WHEN ユーザーが編集フォームの右上のバツボタンをクリックした時 THEN システムは編集フォームを閉じる
5. WHEN ユーザーが記録を更新した時 THEN システムは変更内容を検証し、データベースを更新する

### 要件 3

**ユーザーストーリー:** 子供として、植物の成長を視覚的に確認したいので、各植物（ひまわり、コスモス、朝顔）の高さと気温の変化をグラフで見れるようにしたい

#### 受入基準

1. WHEN ユーザーがグラフ画面にアクセスした時 THEN システムは植物種類（向日葵（ひまわり）、秋桜（コスモス）、朝顔（あさがお））での絞り込み機能と全植物の高さと気温の推移グラフを表示する
2. WHEN ユーザーが植物種類で絞り込みを行った時 THEN システムは選択された植物の詳細グラフ（高さと気温の2軸グラフ）を表示する
3. WHEN グラフの日付軸が表示された時 THEN システムは各日付の下に天気アイコン（晴れ、曇り、雨、雷）を表示する
4. WHEN グラフにデータポイントが表示された時 THEN システムは日付、高さ、気温の詳細情報をツールチップで表示する
5. WHEN 記録データが更新された時 THEN システムは各植物のグラフを自動的に更新する

### 要件 4

**ユーザーストーリー:** 管理者として、ID/パスワードでログインしたいので、安全に管理機能（/admin/以下）にアクセスできるようにしたい

#### 受入基準

1. WHEN 管理者が/admin/にアクセスした時 THEN システムはID/パスワードログイン画面を表示する
2. WHEN 管理者が正しいID/パスワードを入力した時 THEN システムは管理者を管理ダッシュボード（/admin/dashboard）にリダイレクトする
3. WHEN 認証が失敗した時 THEN システムはエラーメッセージを表示し、再ログインを促す
4. WHEN 管理者がログアウトした時 THEN システムはセッションを無効化し、ログイン画面にリダイレクトする
5. WHEN 未認証ユーザーが/admin/以下にアクセスした時 THEN システムはログイン画面にリダイレクトする

### 要件 5

**ユーザーストーリー:** 管理者として、全ての成長記録を確認・編集したいので、管理画面（/admin/以下）で記録の一覧表示と編集機能を利用できるようにしたい

#### 受入基準

1. WHEN 管理者が管理ダッシュボード（/admin/dashboard）にアクセスした時 THEN システムは全ての植物の記録一覧を表示する
2. WHEN 管理者が記録をフィルタリングした時 THEN システムは植物種類、日付範囲での絞り込み結果を表示する
3. WHEN 管理者が記録を編集した時 THEN システムは管理者権限で記録を更新する
4. WHEN 管理者が記録を削除した時 THEN システムは確認後に記録を完全に削除する
5. WHEN 管理者が/admin/以下の各機能にアクセスした時 THEN システムは認証状態を確認し、未認証の場合はログイン画面にリダイレクトする

### 要件 6

**ユーザーストーリー:** ユーザーとして、スマホでアプリのように使いたいので、画面下部にタブナビゲーション（入力、一覧、グラフ）が表示されるようにしたい

#### 受入基準

1. WHEN ユーザーがユーザー画面（/以下）にアクセスした時 THEN システムは画面下部に「入力」「一覧」「グラフ」の3つのタブを表示する
2. WHEN ユーザーが「入力」タブをタップした時 THEN システムは植物記録入力画面を表示し、タブをアクティブ状態にする
3. WHEN ユーザーが「一覧」タブをタップした時 THEN システムは記録一覧画面を表示し、タブをアクティブ状態にする
4. WHEN ユーザーが「グラフ」タブをタップした時 THEN システムはグラフ表示画面を表示し、タブをアクティブ状態にする
5. WHEN ユーザーがスマホでアクセスした時 THEN システムはレスポンシブデザインでタブナビゲーションを最適化して表示する

### 要件 7

**ユーザーストーリー:** ユーザーとして、同じドメインでユーザー機能と管理機能を利用したいので、適切なルーティングでアクセスできるようにしたい

#### 受入基準

1. WHEN ユーザーがルートパス（/）にアクセスした時 THEN システムはユーザー向けの植物記録入力画面（デフォルトタブ）を表示する
2. WHEN ユーザーが/以下のパス（/records、/graphsなど）にアクセスした時 THEN システムはユーザー向け機能を表示する
3. WHEN 管理者が/admin/にアクセスした時 THEN システムは管理者認証を要求する
4. WHEN 認証済み管理者が/admin/以下のパス（/admin/dashboard、/admin/recordsなど）にアクセスした時 THEN システムは管理者向け機能を表示する

### 要件 8

**ユーザーストーリー:** 管理者として、植物の種類を管理したいので、植物種類（ひまわり、コスモス、朝顔）を設定値として追加・編集・削除できるようにしたい

#### 受入基準

1. WHEN 管理者が植物種類設定画面（/admin/plants）にアクセスした時 THEN システムは現在の植物種類一覧を表示する
2. WHEN 管理者が新しい植物種類を追加した時 THEN システムは植物種類をデータベースに保存し、ユーザー画面の選択肢に反映する
3. WHEN 管理者が既存の植物種類を編集した時 THEN システムは変更内容を保存し、関連する記録データも更新する
4. WHEN 管理者が植物種類を削除しようとした時 THEN システムは、その植物種類に関連する成長記録が1件でも存在する場合、削除ができない仕様とし、その旨を伝える警告メッセージを表示する
5. WHEN 管理者が関連記録のない植物種類を削除しようとした時 THEN システムは確認ダイアログを表示し、ユーザーの同意後に削除する
6. WHEN システムが初期化された時 THEN システムはデフォルトで「ひまわり」「コスモス」「朝顔（あさがお）」の3種類を設定する

### 要件 9

**ユーザーストーリー:** 保護者として、子供の記録を関係者以外に見られたくないので、簡単なパスワードでアクセスを制限したい

#### 受入基準

1. WHEN ユーザーがユーザー画面（/以下のパス）に初めてアクセスした時 THEN システムはBasic認証のダイアログを表示する
2. WHEN ユーザーが正しいID/パスワードを入力した時 THEN システムはコンテンツの表示を許可する
3. WHEN 認証が失敗した時 THEN システムはアクセスを拒否する（401 Unauthorizedエラー）
4. WHEN ユーザーが一度認証に成功した時 THEN システムはブラウザセッション中は再認証を要求しない

### 要件 10

**ユーザーストーリー:** 子供として、記録入力画面で今日の記録状況を分かりやすく確認したいので、入力済みの場合は適切な表示と編集への導線を提供してほしい

#### 受入基準

1. WHEN ユーザーが記録入力画面（/）にアクセスした時 THEN システムは今日の記録が既に存在するかを事前にチェックする
2. WHEN 今日の記録が既に存在する時 THEN システムは「今日（きょう）の記録（きろく）は入力済（にゅうりょくず）みです」というメッセージを表示し、入力フォームは表示しない
3. WHEN 入力済みの状態が表示された時 THEN システムは既存の記録内容（天気、気温、植物データ、画像、記録時刻）を見やすく表示する
4. WHEN 入力済みの状態が表示された時 THEN システムは「編集（へんしゅう）する」ボタンを表示し、クリック時に記録一覧画面にリダイレクトして該当記録の編集フォームを自動的に開く
5. WHEN 今日の記録が存在しない時 THEN システムは通常の入力フォームを表示する
6. WHEN システム全体でテキストを表示する時 THEN システムは漢字の後にふりがなを（）で併記して、子供にも読みやすくする

### 要件 11

**ユーザーストーリー:** 開発者として、ローカル環境で開発・テストしたいので、Docker環境でMySQL8とFastAPIが動作するようにしたい

#### 受入基準

1. WHEN 開発者がdocker-compose upを実行した時 THEN システムはMySQL8データベースコンテナとMinIO（S3互換）ストレージコンテナを起動する
2. WHEN 開発者がコンテナを停止・再起動した時 THEN システムはDocker VolumeによってMySQLのデータベース情報とMinIOの画像データが永続化され、消えないことを保証する
3. WHEN FastAPIアプリケーションが起動した時 THEN システムはデータベースに正常に接続する
4. WHEN フロントエンドアプリケーション（Nuxt/Vue）が起動した時 THEN システムはAPIエンドポイントに正常に接続する
5. WHEN 全てのサービスが起動した時 THEN システムは開発環境として正常に動作する

### 要件 12

**ユーザーストーリー:** 開発者として、コードの保守性と再利用性を向上させたいので、登録画面と編集画面で共通のフォームコンポーネントを使用できるようにしたい

#### 受入基準

1. WHEN 開発者が記録入力フォームを作成した時 THEN システムは共通のフォームコンポーネントを使用して、登録と編集の両方で同じUIとロジックを提供する
2. WHEN ユーザーが編集画面にアクセスした時 THEN システムは既存の記録データを正しく読み込み、フォームに表示する
3. WHEN ユーザーが編集画面でフォームを送信した時 THEN システムは正しいAPIエンドポイント（PUT /api/records/{id}）を呼び出して記録を更新する
4. WHEN 編集画面で画像が変更された時 THEN システムは既存の画像を適切に処理し、新しい画像があればアップロードして既存の画像を置き換える
5. WHEN 編集画面で植物データが変更された時 THEN システムは全ての植物種類（記録されていない植物も含む）の編集フィールドを表示し、正しく更新する
6. WHEN 共通フォームコンポーネントが使用された時 THEN システムは登録と編集の両方で一貫したバリデーションとエラーハンドリングを提供する
7. WHEN 編集画面でキャンセルボタンが押された時 THEN システムは確認なしで記録一覧画面に戻る
8. WHEN 編集画面で保存ボタンが押された時 THEN システムは成功メッセージを表示し、記録一覧画面にリダイレクトする
